### "Project 0" For Acorn 215+

This project implements basic functionality:

- PCIe x4
- DMA to onboard DDR
- Identification registers
- SPI flash programming support

### Project / upgrade info
Controlled files:

- create-project.tcl: This was originally generated by Vivado. Needs to be hand maintained. Changes to the block diagram don't require changes to this file.
- bd/project_bd.tcl: This is simply saved from the block diagram (```write_bd_tcl -force project_bd.tcl```)
- constraints/uEVB-early.xdc: These constraints are evaluated before any of the block diagram IP
- constraints/uEVB.xdc: These constraints are evaluated at the "normal" time (usually after block diagram IP)
- scripts/*: Various TCL scripts to automate common tasks
 
Since the project_bd.tcl requires Vivado 2018.2 (exactly), if you want to upgrade to a new version you need to do something like:

- Use old version to open and build project
- Close old version of vivdao
- Open built project in new version of Vivado (directly, not using *.tcl file)
- Upgrade all the IP to latest version of Vivado
- Update block diagram TCL script via ```write_bd_tcl``` from new version of Vivado


### Creating/opening/building the project (Windows)
- First, create the project by running create-project.bat
- Go into the newly created folder `p0-cle-215p` and double-click the .xpr file
- In TCL console run `source scripts/build.tcl`

### Creating/opening/building the project (Linux)
- Open Vivado 2018.2, and in the tcl console run: 
- cd (directory where create-project.tcl lives)
- `source create-project.tcl`
- `cd p0-cle-215p`
- `source scripts/build.tcl`

### Creating MCS for programming the flash

The easiest way is to do: `source scripts/make-mcs.tcl`

### Programming the flash

TBD

### Build Notes:

It is normal to have 3 critical warnings during implementation. The hardware does not pin out the PCIe x4 in the way preferred by Xilinx XDMA block.
In particular, the pinout of the PCIe x4 interface is already selected by the autogenerated constraints file for the XDMA block.
See Top_xdma_0_0_pcie2_ip-PCIE_X0Y0.xdc where it generates:
```
# PCIe Lane 0
set_property LOC GTPE2_CHANNEL_X0Y7 [get_cells {inst/gt_top_i/pipe_wrapper_i/pipe_lane[0].gt_wrapper_i/gtp_channel.gtpe2_channel_i}]
# PCIe Lane 1
set_property LOC GTPE2_CHANNEL_X0Y6 [get_cells {inst/gt_top_i/pipe_wrapper_i/pipe_lane[1].gt_wrapper_i/gtp_channel.gtpe2_channel_i}]
# PCIe Lane 2
set_property LOC GTPE2_CHANNEL_X0Y5 [get_cells {inst/gt_top_i/pipe_wrapper_i/pipe_lane[2].gt_wrapper_i/gtp_channel.gtpe2_channel_i}]
# PCIe Lane 3
set_property LOC GTPE2_CHANNEL_X0Y4 [get_cells {inst/gt_top_i/pipe_wrapper_i/pipe_lane[3].gt_wrapper_i/gtp_channel.gtpe2_channel_i}]
```

The usual way to override autogenerated constraints is to simply put new constraints in a different file, and have have those constraints take effect later
by changing the PROCESSING_ORDER property of the file. See [https://www.xilinx.com/support/answers/52947.html].

However, the LOC property, which is the one we need to change, doesn't work in this fashion, since Vivado can't assign a LOC property to a cell
if the LOC is already in use. And they are all in use. Normally, the reset_property function can fix this, but reset_property doesn't work in constraint files.

This leaves two options:
- Write a tcl script that does synthesis, then does reset_property for the above 4 cells, then does implementation
OR
- Set the correct constraints early (before the IP constraints), and deal with the warnings when Vivado evaluates the (wrong) constraints in the autogenerated IP

This project uses the second option

### Register Map

| Address  | Size (bytes) | Function  |
| ---      | ---          | ---       |
| 0        |  4           | "215+"    |
| 4        |  4           | version   |
| 8-0xFFFF | 64K-8        | unused    |
| 0x10000  | see IP       | AXI-SPI   |

### Memory Map
| Address  | Size  | Function  |
| ---      | ---   | ---       |
| 0        |  1MiB | Mapped to DRAM |




